---
title: "Case Study IV, Interim Report I"
author: "Jake Epstein, Daniel Spottiswood, Man-Lin Hsiao, Michael Tan, Sahil Patel"
date: "10/29/2019"
output:
  html_document: default
  pdf_document: default
---
```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(haven)
library(dplyr)
library(ggplot2)
library(gridExtra)
```


```{r}
#load, clean data
debit = read_dta("data/debitcard199598.dta")

debit = debit %>%
  mutate(average_age = factor(average_age, labels = c("<30", "31-40", "41-50", "51-65", "65+"))) %>% 
  mutate(householder_age = factor(householder_age, labels = c("<30", "31-40", "41-50", "51-65", "65+"))) %>%
  mutate(geograph_area = factor(geograph_area, labels = c("North", "Central Italy", "South and Islands"))) %>%
  mutate(num_of_inhabitants = factor(num_of_inhabitants, labels = c("<20k", "20-40k", "40-500k", "500k+"))) %>%
  mutate(householder_education = factor(householder_education, labels = c("None", "Elementary", "Middle School", "High School", "Bachelors", "Post-Graduate"))) %>%
  mutate(spending1995 = as.numeric(spending1995), spending1998 = as.numeric(spending1998), debit_card1998 = as.logical(debit_card1998))
```


## Introduction

The goal of this case study is to evaluate the causal impact of debit card ownership on household spending. The data come from the Italy Survey on Household Income and Wealth (SHIW), a 1995-1998 survey of 584 Italian households. The dataset includes 1995 and 1998 monthly household spending, whether the household had exactly one debit card in 1998 and demographic information including family size, geographic region and average age. In this report, we will create a model to estimate the causal impact of debit card ownership on household spending, utilizing propensity score methods to ensure model balance.


## Exploratory Data Analysis


```{r, fig.width=15, fig.height=7}
# simple spending, 95 v 98


spend95 = ggplot(debit, aes(x = spending1995, fill = debit_card1998)) +
  geom_density(alpha = 0.5, show.legend = FALSE) +
  labs(title = "1995 Household Spending", fill = "Debit Card?", x = "Monthly Average Spending ($)", y = "Density") +
  xlim(0, 5000)+
  theme_minimal()

spend98 = ggplot(debit, aes(x = spending1998, fill = debit_card1998)) +
  geom_density(alpha = 0.5, show.legend = FALSE) +
  labs(title = "1998 Household Spending", fill = "Debit Card?", x = "Monthly Average Spending ($)", y = "Density") +
  xlim(0, 5000)+
  theme_minimal()

#change in spending over time

debit = debit %>%
  mutate(delta = spending1998-spending1995)

diff = ggplot(debit, aes(x = delta, fill = debit_card1998)) +
  geom_density(alpha = 0.5) +
  labs(title = "Change in Spending", fill = "Debit Card", x = "Change in Monthly Average Spending ($)", y = "Density") +
  # xlim(0, 5000)+
  theme_minimal()

scatter = ggplot(debit, aes(x = spending1995, y = spending1998, color = debit_card1998))+
  geom_point() +
  theme_minimal() +
  theme(legend.position = "none", legend.title = element_blank())+
  labs(x = "1995 Monthly Household Spending ($)", y = "1998 Monthly Household Spending ($)", fill = "Debit Card?",
       title = "1995 vs 1998 Debit Card Use and Household Spending") +
  geom_smooth(method = "lm")

grid.arrange(spend95, diff, spend98, scatter, nrow = 2)


debit = debit %>%
  mutate(spend95_pct_income = spending1995 / income * 12 * 100) %>%
  mutate(spend98_pct_income = spending1998 / income * 12 * 100) %>%
  mutate(spend95_pct_wealth = spending1995 / wealth * 100) %>%
  mutate(spend98_pct_wealth = spending1998 / wealth * 100)

```

We begin our exploratory data analysis by looking at spending. In 1995 and 1998, households with debit cards tended to spend more than households without. The distribution of difference in household spending is centered at around 0, indicating most households spent about the same amount in 1998 as they did in 1995. The distribution of changes for households with debit cards has slighly more weight on the positive side, indicating that these households may have increased their spending slightly relative to non-debit card households. We also looked into spending as a percentage of income or of wealth, and the results were consistent with those above.

```{r, include = FALSE}
# no different -- don't include

# spending as a % of income, wealth 1995 vs 1998

spend95_inc = ggplot(debit %>% filter(income > 0), aes(x = spend95_pct_income, fill = debit_card1998)) +
  geom_density(alpha = 0.5) +
  labs(title = "1995 Household Spending as a Percent of Income", fill = "Debit Card?", x = "Monthly Average Spending (% Income)", y = "Density") +
  xlim(0, 125) +
  theme_minimal()

spend98_inc = ggplot(debit %>% filter(income > 0), aes(x = spend98_pct_income, fill = debit_card1998)) +
  geom_density(alpha = 0.5) +
  labs(title = "1998 Household Spending as a Percent of Income", fill = "Debit Card?", x = "Monthly Average Spending (% Income)", y = "Density") +
  xlim(0, 125) +
  theme_minimal()

grid.arrange(spend95_inc, spend98_inc, nrow = 2)

spend95_wealth = ggplot(debit %>% filter(wealth > 0), aes(x = spend95_pct_wealth, fill = debit_card1998)) +
  geom_density(alpha = 0.5) +
  labs(title = "1995 Household Spending as a Percent of Wealth", fill = "Debit Card?", x = "Monthly Average Spending (% Wealth)", y = "Density") +
  xlim(0, 2.5) +
  theme_minimal()

spend98_wealth = ggplot(debit %>% filter(wealth > 0), aes(x = spend98_pct_wealth, fill = debit_card1998)) +
  geom_density(alpha = 0.5) +
  labs(title = "1998 Household Spending as a Percent of Wealth", fill = "Debit Card?", x = "Monthly Average Spending (% Wealth)", y = "Density") +
  xlim(0, 2.5) +
  theme_minimal()

grid.arrange(spend95_wealth, spend98_wealth, nrow = 2)


```

```{r, fig.width=15, fig.height=7}
#categorical variables


spend_debit = ggplot(debit, aes(y = spending1998, x = debit_card1998, fill = debit_card1998)) +
  geom_boxplot(width = .1, show.legend = FALSE) +
  geom_violin(trim = TRUE, alpha = .5, show.legend = FALSE) +
  theme_minimal() +
  labs(y = "1998 Spending", x = "Debit Card")

# spend_debit #meh

spend_age = ggplot(debit, aes(y = spending1998, x = average_age, fill = average_age)) +
  geom_boxplot(width = .1, show.legend = FALSE) +
  geom_violin( alpha = .5, show.legend = FALSE) +
  theme_minimal() +
  labs(y = "1998 Spending", x = "Average Age")

# spend_age #not super impactful

spend_hhage = ggplot(debit, aes(y = spending1998, x = householder_age, fill = householder_age)) +
  geom_boxplot(width = .1, show.legend = FALSE) +
  geom_violin( alpha = .5, show.legend = FALSE) +
  theme_minimal() +
  labs(y = "1998 Spending", x = "Head of Household Age")

# spend_hhage #similar to avg age

spend_geo = ggplot(debit, aes(y = spending1998, x = geograph_area, fill = geograph_area)) +
  geom_boxplot(width = .1, show.legend = FALSE) +
  geom_violin( alpha = .5, show.legend = FALSE) +
  theme_minimal() +
  labs(y = "1998 Spending", x = "Geography")

# spend_geo # meh

spend_fam_size = ggplot(debit, aes(y = spending1998, x = as.factor(family_size), fill = as.factor(family_size))) +
  geom_boxplot(width = .1, show.legend = FALSE) +
  geom_violin( alpha = .5, show.legend = FALSE) +
  theme_minimal() +
  labs(y = "1998 Spending", x = "Family Size")

# spend_fam_size # intuitive trend

spend_edu = ggplot(debit, aes(y = spending1998, x = householder_education, fill = householder_education)) +
  geom_boxplot(width = .1, show.legend = FALSE) +
  geom_violin( alpha = .5, show.legend = FALSE) +
  theme_minimal() +
  labs(y = "1998 Spending", x = "Head of Household Education")

# spend_edu # i like

spend_inhab = ggplot(debit, aes(y = spending1998, x = num_of_inhabitants, fill = num_of_inhabitants)) +
  geom_boxplot(width = .1, show.legend = FALSE) +
  geom_violin( alpha = .5, show.legend = FALSE) +
  theme_minimal() +
  labs(y = "1998 Spending", x = "Number of Inhabitants")

# spend_inhab # ubran spend more

# ggplot(debit %>% filter(wealth < 1e6), aes(y = wealth, x = householder_education, fill = householder_education)) +
#   geom_boxplot(width = .1, show.legend = FALSE) +
#   geom_violin( alpha = .5, show.legend = FALSE) +
#   theme_minimal() +
#   labs(y = "Wealth", x = "Head of Household Education")


# continuous relationships

spend_wealth = ggplot(debit, aes(y = spending1998, x = wealth, color = debit_card1998))+
  geom_point() +
  theme_minimal() +
  geom_smooth(method = "lm") +
  labs(y = "1998 Spending", x = "Wealth", title = "Wealth vs. Spending")

spend_inc = ggplot(debit, aes(y = spending1998, x = income, color = debit_card1998))+
  geom_point() +
  theme_minimal() +
  geom_smooth(method = "lm") +
  labs(y = "1998 Spending", x = "Income", title = "Income vs. Spending")

# spend_inc # same as wealth

spend_ir = ggplot(debit, aes(y = spending1998, x = interest_rate, color = debit_card1998))+
  geom_point() +
  theme_minimal() +
  geom_smooth(method = "lm") +
  ylim(0, 5000) +
  labs(y = "1998 Spending", x = "Interest Rate", title = "Interest Rate vs. Spending")

# spend_ir # no real relationship

spend_banks = ggplot(debit %>% filter(num_of_banks < 500), aes(y = spending1998, x = num_of_banks, color = debit_card1998))+
  geom_point() +
  theme_minimal() +
  geom_smooth(method = "lm") +
  # ylim(0, 5000) +
  labs(y = "1998 Spending", x = "Number of Banks", title = "Banks vs. Spending")

# spend_banks # no relationship


grid.arrange(arrangeGrob(spend_edu, spend_fam_size, ncol = 1), spend_wealth, nrow = 1)

```

We then examined relationships between demographic characteristics and 1998 spending. Some selected plots are shown above. Our initial analysis indicates that family size is positively associated with spending, which is intuitive given the cost of raising children. Additionally, families with household heads who have higher educational status tend to spend more than those headed by less educated individuals. This may be a function of income or wealth, as higher educated individuals tend to earn more; regardless, it is worth exploring further. Finally, both income and wealth are positively associated with spending, and households with debit cards tend to spend more at all levels of income and wealth. 

```{r}
###pct of income, no different than above
# 
# ggplot(debit %>% filter(income > 3000), aes(y = spend98_pct_income, x = debit_card1998, fill = debit_card1998)) +
#   geom_boxplot(width = .1, show.legend = FALSE) +
#   geom_violin(trim = TRUE, alpha = .5, show.legend = FALSE) +
#   theme_minimal() +
#   labs(y = "1998 Spending (% of Income)", x = "Debit Card")
# 
# ggplot(debit %>% filter(income > 3000), aes(y = spend98_pct_income, x = average_age, fill = average_age)) +
#   geom_boxplot(width = .1, show.legend = FALSE) +
#   geom_violin( alpha = .5, show.legend = FALSE) +
#   theme_minimal() +
#   labs(y = "1998 Spending (% of Income)", x = "Average Age")
# 
# ggplot(debit %>% filter(income > 3000), aes(y = spend98_pct_income, x = householder_age, fill = householder_age)) +
#   geom_boxplot(width = .1, show.legend = FALSE) +
#   geom_violin( alpha = .5, show.legend = FALSE) +
#   theme_minimal() +
#   labs(y = "1998 Spending (% of Income)", x = "Head of Household Age")
# 
# ggplot(debit %>% filter(income > 3000), aes(y = spend98_pct_income, x = geograph_area, fill = geograph_area)) +
#   geom_boxplot(width = .1, show.legend = FALSE) +
#   geom_violin( alpha = .5, show.legend = FALSE) +
#   theme_minimal() +
#   labs(y = "1998 Spending (% of Income)", x = "Geography")
```


## Data Balancing


## Model Selection


## Conclusions



